#!/bin/bash
# PayloadForge - Modular Architecture
# Convert OTA packages to flashable ZIPs

set -euo pipefail

# Get script directory (resolve symlinks)
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"

# Load all library modules
for module in \
    "$SCRIPT_DIR/lib/utils/logging.sh" \
    "$SCRIPT_DIR/lib/utils/validation.sh" \
    "$SCRIPT_DIR/lib/core/config.sh" \
    "$SCRIPT_DIR/lib/core/partitions.sh" \
    "$SCRIPT_DIR/lib/extraction/ota.sh" \
    "$SCRIPT_DIR/lib/conversion/sparse.sh" \
    "$SCRIPT_DIR/lib/conversion/dat.sh" \
    "$SCRIPT_DIR/lib/conversion/brotli.sh" \
    "$SCRIPT_DIR/lib/conversion/processor.sh" \
    "$SCRIPT_DIR/lib/generation/op_list.sh" \
    "$SCRIPT_DIR/lib/generation/updater_script.sh" \
    "$SCRIPT_DIR/lib/generation/package.sh"
do
    source "$module" || {
        echo "ERROR: Failed to load $module"
        exit 1
    }
done

# Main workflow
main() {
    local input_file=""
    local mode="template"  # Default to template mode
    local custom_partitions=""
    
    # Parse arguments directly (not in subshell)
    while [ $# -gt 0 ]; do
        case "$1" in
            -v|--verbose)
                VERBOSE="true"
                VERBOSE_SOURCE="cli"
                LOG_LEVEL="DEBUG"
                LOG_LEVEL_SOURCE="cli"
                log_set_level "$LOG_LEVEL"
                shift
                ;;
            --log-level)
                LOG_LEVEL="$2"
                LOG_LEVEL_SOURCE="cli"
                log_set_level "$LOG_LEVEL"
                shift 2
                ;;
            --log-context)
                LOG_CONTEXT="$2"
                LOG_CONTEXT_SOURCE="cli"
                shift 2
                ;;
            -d|--debug)
                LOG_LEVEL="DEBUG"
                LOG_LEVEL_SOURCE="cli"
                LOG_CONTEXT="full"
                LOG_CONTEXT_SOURCE="cli"
                log_set_level "$LOG_LEVEL"
                shift
                ;;
            -p|--partitions)
                mode="manual"
                custom_partitions="$2"
                shift 2
                ;;
            -i|--interactive)
                mode="interactive"
                shift
                ;;
            -t|--threads)
                MAX_THREADS="$2"
                shift 2
                ;;
            -b|--brotli)
                BROTLI_LEVEL="$2"
                if [ "$BROTLI_LEVEL" = "0" ]; then
                    USE_COMPRESSION="false"
                fi
                shift 2
                ;;
            -z|--zip)
                ZIP_COMPRESSION_LEVEL="$2"
                shift 2
                ;;
            -h|--help)
                banner
                show_usage
                exit 0
                ;;
            *)
                if [ -z "$input_file" ]; then
                    input_file="$1"
                fi
                shift
                ;;
        esac
    done
    
    # Validate input
    if [ -z "$input_file" ]; then
        log_error "No input file specified"
        show_usage
        exit 1
    fi
    
    if [ ! -f "$input_file" ]; then
        log_error "File not found: $input_file"
        exit 1
    fi
    
    # Set globals
    INPUT_FILE="$input_file"
    INPUT_FILE_NAME="$input_file"
    
    banner
    
    # Initialize environment
    init_environment
    load_user_config
    
    # Validate input file
    validate_input_file "$INPUT_FILE" > /dev/null || exit 1
    
    # Check dependencies
    check_dependencies || exit 1
    
    cleanup
    mkdir -p "$TEMP_DIR"/{partitions,output,config}
    
    log_info "Input: $INPUT_FILE"
    log_info "Threads: $MAX_THREADS"
    
    # Extract OTA payload
    extract_ota "$INPUT_FILE" || exit 1
    extract_payload || exit 1
    
    # Set dynamic partition config
    if [ -z "$GROUP_TABLE" ] || [ -z "$GROUP_TABLE_SIZE" ]; then
        log_info "Using default dynamic partition config..."
        GROUP_TABLE="${GROUP_TABLE:-main}"
        GROUP_TABLE_SIZE="${GROUP_TABLE_SIZE:-9663676416}"  # Default: ~9GB
    else
        log_info "Using saved dynamic partition config from previous run..."
    fi
    
    # Select partitions
    select_partitions "$mode" "$custom_partitions" || exit 1
    
    # Filter valid partitions
    filter_partitions || exit 1
    
    # Process all partitions
    process_partitions || exit 1
    
    # Calculate optimal GROUP_TABLE_SIZE based on actual partition data
    echo ""
    if ! calculate_group_table_size; then
        log_warn "Using configured/default GROUP_TABLE_SIZE: $GROUP_TABLE_SIZE bytes"
    fi
    
    # Generate flashable package
    echo ""
    generate_dynamic_partitions_op_list || exit 1
    generate_updater_script || exit 1
    package_flashable_zip || exit 1
    
    # Cleanup
    cleanup
    
    log_blank
    log_success "PayloadForge completed successfully!"
    if [ -n "${GENERATED_ZIP_PATH-}" ]; then
        log_emit_with_logger "INFO" "payloadforge.generation.package" "Full path: $GENERATED_ZIP_PATH"
    fi
}

# Error handler
trap 'log_error "Script failed at line $LINENO"; cleanup; exit 1' ERR

# Run main
main "$@"
